<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PNLE Bulk Uploader (Smart Fix) - AUTO FILTER</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f4f6f8; color: #333; }
    h2 { color: #2c3e50; border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-top: 0; }
    
    /* INPUT AREA */
    textarea { width: 100%; height: 250px; padding: 15px; font-size: 14px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; font-family: "Courier New", monospace; line-height: 1.4; resize: vertical; }
    textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.2); }

    /* BUTTONS */
    .controls { margin: 20px 0; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .controls-row { display:flex; gap:10px; flex-wrap:wrap; align-items: center; }
    button { padding: 10px 18px; font-size: 14px; font-weight: 600; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: all 0.2s; }
    button:hover { background-color: #0056b3; transform: translateY(-1px); }
    button#btnClear { background-color: #6c757d; }
    button#btnClear:hover { background-color: #545b62; }
    button.danger { background-color: #dc3545; }
    button.danger:hover { background-color: #a71d2a; }
    button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

    /* STATUS & PREVIEW */
    .status { margin-top: 15px; font-weight: 600; color: #495057; padding: 10px; background: #e9ecef; border-radius: 4px; border-left: 5px solid #007bff; }
    
    .preview-container { margin-top: 20px; }
    .preview-header { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333; }
    
    .question-card { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
    
    /* ERROR DESIGN - Eto yung fix sa "Missing" */
    .question-card.error-card { border: 2px solid #dc3545; background-color: #fff5f5; }
    .error-msg { color: #dc3545; font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px; }

    /* TEXT STYLES */
    .q-text { font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 15px; }
    .choices-box { margin-left: 15px; font-size: 14px; color: #555; border-left: 2px solid #eee; padding-left: 10px; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
    .badge-ans { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .badge-topic { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    .badge-missing { background-color: #dc3545; color: white; }

    .meta-box { margin-top: 10px; font-size: 13px; color: #666; background: #f8f9fa; padding: 8px; border-radius: 4px; }
    
    /* TABLE FOR DB VIEW */
    .db-list { max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th { background: #f1f1f1; font-weight: 600; color: #555; position: sticky; top: 0; z-index: 10; }
    th, td { text-align:left; padding: 12px; border-bottom:1px solid #eee; font-size: 14px; vertical-align: top; }
    tr:hover { background-color: #f9f9f9; }
    
    .muted { color:#666; font-size:13px; line-height: 1.5; }
  </style>
</head>
<body>

  <h2>PNLE Bulk Uploader (Fixed Version)</h2>

  <p class="muted">
    <b>Instructions:</b> Paste questions below. Separate blocks with an empty line.<br>
    Format: Question, Choices (A-D), Answer: X, Rationale: ...
  </p>

  <textarea id="bulkRaw" placeholder="Paste your questions here...

1. A nurse is caring for a client...
A. Choice 1
B. Choice 2
C. Choice 3
D. Choice 4
Answer: A
Rationale: This is the reason.
Source: Saunders"></textarea>

  <div class="controls">
    <div class="controls-row">
      <button id="btnPreview">1. Preview & Check Errors</button>
      <button id="btnUpload" disabled>2. Upload Valid Items</button>
      <button id="btnClear">Clear</button>
      <button id="btnFetch" style="margin-left:auto; background:#17a2b8;">View Database</button>
    </div>
    <div class="status" id="status">Waiting for input...</div>
  </div>

  <div id="previewContainer" class="preview-container" style="display:none">
    <div class="preview-header">Preview Result</div>
    <div id="previewList"></div>
  </div>

  <div id="dbContainer" class="preview-container" style="display:none">
    <div class="preview-header">Uploaded Questions (Live DB)</div>
    <div id="uploadedList" class="db-list"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, deleteDoc, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- FIREBASE CONFIG (Check your Rules if upload fails!) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCmd6vmuXUPslLJf0w7I518C8UIaO2DoAA",
      authDomain: "pnle-class.firebaseapp.com",
      projectId: "pnle-class",
      storageBucket: "pnle-class.firebasestorage.app",
      messagingSenderId: "1024768890816",
      appId: "1:1024768890816:web:28bf31d5ae67c679feda25",
      measurementId: "G-JLS5ZGFP3J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- UTILS ---
    const escapeHtml = (str) => (!str ? "" : str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]));
    const cleanText = (s) => (s || "").replace(/\s+/g, " ").trim();

    // --- TOPIC DETECTION ---
    function detectTopic(text) {
      const q = text.toLowerCase();
      // Explicit Override
      const explicit = text.match(/NP\s*[:\-]\s*(NP[1-5])/i);
      if (explicit) return explicit[1].toUpperCase();

      // Keywords
      const map = {
        NP1: ["community", "doh", "immunization", "chn", "public health", "prevention", "epidemiology"],
        NP2: ["medical", "surgical", "emergency", "cardiac", "respiratory", "fluid", "electrolyte", "oncology"],
        NP3: ["maternal", "child", "ob", "pedia", "pregnancy", "labor", "newborn", "growth"],
        NP4: ["leadership", "management", "research", "ethics", "legal", "delegation", "priority"],
        NP5: ["psych", "mental", "behavior", "communication", "coping", "abuse"] // Moved mental health to NP5 usually, or adjust as needed
      };

      // Prioritize NP5 for mental health often, or rely on user keywords
      if (map.NP3.some(w => q.includes(w))) return "NP3";
      if (map.NP4.some(w => q.includes(w))) return "NP4";
      if (map.NP5.some(w => q.includes(w))) return "NP5";
      if (map.NP1.some(w => q.includes(w))) return "NP1";
      
      return "NP2"; // Default
    }

    // --- PARSER ---
    function parseBlock(block) {
      const lines = block.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
      if (lines.length === 0) return null;

      // Question is usually the first line that looks like a sentence
      let question = lines[0].replace(/^\d+[\.\)\-]\s*/, "").trim(); 
      
      let choices = { A: "", B: "", C: "", D: "" };
      let answer = "";
      let rationale = "";
      let source = "";

      // Regex Logic
      lines.forEach(line => {
        // Clean invisible chars
        const cleanLine = line.replace(/[\u200B-\u200D\uFEFF]/g, ''); 
        
        // Detect Answer
        const ansMatch = cleanLine.match(/^(?:Answer|Ans|ANS)\s*[:\-\.]\s*([A-Za-z])/i);
        if (ansMatch) { answer = ansMatch[1].toUpperCase(); return; }

        // Detect Rationale
        const ratMatch = cleanLine.match(/^(?:Rationale|Rat)\s*[:\-\.]\s*(.*)/i);
        if (ratMatch) { rationale = ratMatch[1]; return; }

        // Detect Source
        if (cleanLine.match(/^Source:/i) || cleanLine.match(/^http/i)) {
             source = cleanLine.replace(/^Source:\s*/i, ""); 
             return;
        }

        // Detect Choices (More flexible regex)
        const choiceMatch = cleanLine.match(/^([A-Da-d])\s*[\.\)\-]\s*(.*)/);
        if (choiceMatch && !cleanLine.toLowerCase().startsWith("answer")) {
          const letter = choiceMatch[1].toUpperCase();
          if (choices[letter] !== undefined) choices[letter] = choiceMatch[2];
        }
      });

      // Validation
      const missing = [];
      if (!question) missing.push("Question");
      if (!choices.A) missing.push("A");
      if (!choices.B) missing.push("B");
      if (!choices.C) missing.push("C");
      if (!choices.D) missing.push("D");
      if (!answer) missing.push("Answer");

      return {
        question, choices, answer, rationale, source, 
        topic: detectTopic(block),
        isValid: missing.length === 0,
        missing: missing,
        raw: block
      };
    }

    function parseBulk(raw) {
      // Split by double newline or "---"
      const blocks = raw.split(/\n\s*\n|---/).map(b => b.trim()).filter(b => b.length > 10);
      return blocks.map(parseBlock).filter(p => p !== null);
    }

    // --- UI LOGIC ---
    const els = {
      raw: document.getElementById("bulkRaw"),
      previewBtn: document.getElementById("btnPreview"),
      uploadBtn: document.getElementById("btnUpload"),
      clearBtn: document.getElementById("btnClear"),
      fetchBtn: document.getElementById("btnFetch"),
      status: document.getElementById("status"),
      previewList: document.getElementById("previewList"),
      previewCont: document.getElementById("previewContainer"),
      dbCont: document.getElementById("dbContainer"),
      dbList: document.getElementById("uploadedList")
    };

    let parsedData = [];

    els.previewBtn.addEventListener("click", () => {
      const raw = els.raw.value;
      if (!raw.trim()) {
        els.status.innerHTML = "Please paste text first.";
        return;
      }

      parsedData = parseBulk(raw);
      els.previewCont.style.display = "block";
      els.dbCont.style.display = "none";
      
      if (parsedData.length === 0) {
        els.status.innerHTML = "No questions detected. Check format.";
        els.previewList.innerHTML = "<div style='padding:10px'>No data found.</div>";
        return;
      }

      let validCount = 0;
      let html = "";

      parsedData.forEach((p, i) => {
        if (p.isValid) validCount++;
        
        const errorClass = p.isValid ? "" : "error-card";
        const errorMsg = p.isValid ? "" : `<span class="error-msg">⚠️ MISSING: ${p.missing.join(", ")}</span>`;
        
        html += `
          <div class="question-card ${errorClass}">
            ${errorMsg}
            <div style="display:flex; justify-content:space-between; align-items:flex-start">
              <span class="badge badge-topic">${p.topic}</span>
              <span class="badge ${p.isValid ? 'badge-ans' : 'badge-missing'}">Answer: ${p.answer || "?"}</span>
            </div>
            
            <div class="q-text">Q${i+1}. ${escapeHtml(p.question)}</div>
            
            <div class="choices-box">
              ${p.choices.A ? `A. ${escapeHtml(p.choices.A)}` : `<span style="color:red">A. (Missing)</span>`}<br>
              ${p.choices.B ? `B. ${escapeHtml(p.choices.B)}` : `<span style="color:red">B. (Missing)</span>`}<br>
              ${p.choices.C ? `C. ${escapeHtml(p.choices.C)}` : `<span style="color:red">C. (Missing)</span>`}<br>
              ${p.choices.D ? `D. ${escapeHtml(p.choices.D)}` : `<span style="color:red">D. (Missing)</span>`}
            </div>

            ${p.rationale ? `<div class="meta-box"><b>Rationale:</b> ${escapeHtml(p.rationale)}</div>` : ""}
            ${p.source ? `<div style="font-size:11px; margin-top:5px; color:#999">Src: ${escapeHtml(p.source)}</div>` : ""}
          </div>
        `;
      });

      els.previewList.innerHTML = html;
      
      if (validCount > 0) {
        els.uploadBtn.disabled = false;
        els.uploadBtn.textContent = `2. Upload ${validCount} Valid Items`;
        els.status.innerHTML = `Found <b>${parsedData.length}</b> blocks. <b>${validCount}</b> are ready to upload.`;
        if (validCount < parsedData.length) {
            els.status.innerHTML += ` <span style="color:red">(Fix the red cards first!)</span>`;
        }
      } else {
        els.uploadBtn.disabled = true;
        els.uploadBtn.textContent = "Fix Errors First";
        els.status.innerHTML = "<span style='color:red'>All items have errors. Cannot upload.</span>";
      }
    });

    els.uploadBtn.addEventListener("click", async () => {
      const validItems = parsedData.filter(p => p.isValid);
      if (validItems.length === 0) return;

      els.uploadBtn.disabled = true;
      els.uploadBtn.textContent = "Uploading...";
      els.status.textContent = "Uploading to Firebase...";

      let successCount = 0;
      let errorCount = 0;

      for (const item of validItems) {
        try {
          // Prepare Data
          const docData = {
            question: cleanText(item.question),
            choices: {
              A: cleanText(item.choices.A),
              B: cleanText(item.choices.B),
              C: cleanText(item.choices.C),
              D: cleanText(item.choices.D)
            },
            answer: item.answer,
            rationale: cleanText(item.rationale),
            source: cleanText(item.source),
            topic: item.topic,
            timestamp: Date.now()
          };

          const newDocRef = doc(collection(db, "ALL_TOPICS"));
          const id = newDocRef.id;

          // Write to ALL_TOPICS and Specific Topic
          await setDoc(newDocRef, docData);
          await setDoc(doc(db, item.topic, id), docData);
          
          successCount++;
        } catch (err) {
          console.error("Upload failed for one item:", err);
          errorCount++;
        }
      }

      els.status.innerHTML = `<b>Done!</b> Uploaded: ${successCount}. Errors: ${errorCount}.`;
      alert(`Success: ${successCount}\nFailed: ${errorCount}`);
      
      els.uploadBtn.textContent = "Upload Complete";
      els.raw.value = ""; // Clear input on success
      els.previewCont.style.display = "none";
      
      // Auto refresh list
      fetchDatabase();
    });

    els.clearBtn.addEventListener("click", () => {
        els.raw.value = "";
        els.previewCont.style.display = "none";
        els.status.textContent = "Cleared.";
    });

    els.fetchBtn.addEventListener("click", fetchDatabase);

    async function fetchDatabase() {
      els.previewCont.style.display = "none";
      els.dbCont.style.display = "block";
      els.dbList.innerHTML = "<div style='padding:10px'>Loading database...</div>";

      try {
        const q = query(collection(db, "ALL_TOPICS"), orderBy("timestamp", "desc"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          els.dbList.innerHTML = "<div style='padding:10px'>Database is empty.</div>";
          return;
        }

        let html = `<table>
          <thead>
            <tr>
              <th width="60%">Details</th>
              <th>Topic</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>`;

        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          html += `
            <tr id="row-${docSnap.id}">
              <td>
                <div style="font-weight:bold">${escapeHtml(d.question)}</div>
                <div style="font-size:12px; color:#666; margin-top:4px;">
                   Ans: <b style="color:green">${d.answer}</b> | Rat: ${escapeHtml(d.rationale || "None")}
                </div>
              </td>
              <td><span class="badge badge-topic">${d.topic}</span></td>
              <td>
                <button class="danger" style="padding:5px 10px; font-size:12px;" 
                  onclick="window.deleteItem('${docSnap.id}', '${d.topic}')">Delete</button>
              </td>
            </tr>
          `;
        });
        
        html += "</tbody></table>";
        els.dbList.innerHTML = html;
        els.status.textContent = `Loaded ${snapshot.size} questions from DB.`;

      } catch (err) {
        els.dbList.innerHTML = `<div style="color:red; padding:10px;">Error loading DB: ${err.message}<br>Check Firebase Console > Firestore Database > Rules</div>`;
      }
    }

    // Expose Delete to Window
    window.deleteItem = async (id, topic) => {
      if(!confirm("Are you sure you want to delete this?")) return;
      try {
        await deleteDoc(doc(db, "ALL_TOPICS", id));
        if(topic) await deleteDoc(doc(db, topic, id));
        
        // Remove from UI
        const row = document.getElementById(`row-${id}`);
        if(row) row.style.display = 'none';
      } catch(e) {
        alert("Error deleting: " + e.message);
      }
    };

  </script>
</body>
</html>
